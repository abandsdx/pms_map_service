# Nuwa 地圖與日誌服務

## 總覽

本應用程式是一個與女媧機器人 (Nuwa Robotics) 服務互動的橋樑與工具。它已被重構成一個支援多租戶、具備進階驗證功能與國際化的服務。

其主要功能有：
1.  **個人化 MQTT 日誌串流**：每位使用者都可以設定自己的 MQTT 代理資訊。服務會為其建立專屬連線，並將日誌即時串流到網頁介面。
2.  **地圖資料下載器**：從女媧機器人任務系統 (RMS) API 獲取地圖資料與圖片。
3.  **金鑰管理**：一個安全的、雙層級的金鑰系統，用來管理服務的存取權限。

## 功能特性

-   **多租戶 MQTT**：每位使用者都可以擁有獨立的 MQTT 代理設定，並被永久儲存。
-   **動態金鑰管理**：透過一個由主金鑰保護的安全管理介面，可以即時產生和撤銷使用者 API 金鑰。
-   **統一登入流程**：一個單一的登入頁面，能智慧地根據使用者提供的金鑰類型（主金鑰或使用者金鑰），將其導向管理介面或日誌檢視器。
-   **國際化 (i18n)**：前端介面完全雙語化，支援英文 (English) 和繁體中文，並以英文為預設語言。
-   **主金鑰自動產生**：首次啟動時，若未提供主金鑰，系統會自動產生一個安全的金鑰，簡化了初始設定流程。
-   **資料持久化**：所有的設定（使用者金鑰、MQTT 設定）都會以 JSON 檔案的形式，透過 volume 掛載來永久儲存。

## 開始使用

### 1. 設定主金鑰 (建議作法)

-   **複製範例檔案**：`cp .env.example .env`
-   **設定您的主金鑰**：打開新的 `.env` 檔案，並將預設值替換為一個真實、安全的金鑰（可使用 `openssl rand -hex 16` 產生）。
    ```
    MASTER_KEY=your_super_secret_master_key_here
    ```

### 2. 建置並運行服務
```bash
docker-compose up -d --build
```
服務將會啟動於 `http://localhost:8000`。

### 備用方案：首次啟動自動產生
如果您在啟動服務時沒有建立 `.env` 檔案，系統會自動產生一個主金鑰並顯示在終端機日誌中。您可以複製此金鑰並存入 `.env` 檔案以供未來使用。

## 使用流程

### 1. 登入
-   前往服務首頁：`http://localhost:8000/`。
-   您會看到一個統一的登入頁面。

### 2. 管理員：建立使用者金鑰
-   在登入頁面，輸入您的**主金鑰**。
-   您將被自動導向至 `/admin` 管理頁面。
-   點擊「產生新金鑰」來建立一個**使用者 API 金鑰**，並複製它。
-   您可以使用右上角的下拉選單切換管理介面的語言。

### 3. 使用者：設定 MQTT 並檢視日誌
-   回到登入頁面 (`/`)。
-   輸入您剛剛產生的**使用者 API 金鑰**。
-   您將被自動導向至 `/log` 日誌檢視頁面。
-   透過導覽列前往 `/settings`，在這裡您可以輸入您個人的 MQTT 代理資訊。此設定將會與您的金鑰綁定並被儲存。
-   回到 `/log` 頁面，即可看到來自您所設定的代理的即時日誌。
-   語言可以隨時透過下拉選單切換，您的偏好會被記在當前的瀏覽器 session 中。

## 專案結構

```
.
├── app/
│   ├── auth.py             # 驗證與 API 金鑰邏輯
│   ├── main.py             # FastAPI 應用程式主體
│   ├── map_downloader.py   # 地圖下載邏輯
│   ├── mqtt_manager.py     # 個人化 MQTT 連線管理
│   └── templates/
│       ├── admin.html      # 管理頁面
│       ├── log.html        # 日誌檢視頁面
│       ├── login.html      # 統一登入頁面
│       └── settings.html   # MQTT 設定頁面
├── locales/
│   ├── en.json             # 英文 UI 字串
│   └── zh_TW.json          # 繁體中文 UI 字串
├── api_keys.txt            # 儲存使用者 API 金鑰
├── mqtt_configs.json       # 儲存個人化 MQTT 設定
├── docker-compose.yml      # Docker Compose 設定檔
├── Dockerfile              # Docker 映像檔設定
├── entrypoint.sh           # 用於主金鑰產生的啟動腳本
├── .env.example            # 環境變數範例檔
└── requirements.txt        # Python 依賴套件
```
