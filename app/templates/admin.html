<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Administration</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 1em auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #5a5a5a; border-bottom: 1px solid #eee; padding-bottom: 0.5em;}
        nav { background: #333; padding: 1em; text-align: center; }
        nav a { color: white; text-decoration: none; margin: 0 1em; font-size: 1.1em; }
        nav a.active { font-weight: bold; text-decoration: underline; }
        .hidden { display: none; }
        #login-view, #management-view { margin-top: 1em; }
        input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 1em; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        .notice { background-color: #e9f7ff; border-left: 5px solid #007bff; padding: 1em; margin-bottom: 1.5em; }
        #key-list { list-style-type: none; padding: 0; }
        #key-list li { font-family: monospace; background: #eee; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
        .revoke-btn, #logout-btn { background-color: #dc3545; }
        .revoke-btn:hover, #logout-btn:hover { background-color: #c82333; }
        #new-key-display { background: #d4edda; color: #155724; padding: 1em; margin-top: 1em; border-radius: 4px; word-wrap: break-word; font-family: monospace; }
        #error-message { color: #dc3545; margin-top: 1em; }
    </style>
</head>
<body>
    <nav>
        <a href="/">Log Viewer</a>
        <a href="/settings">MQTT Settings</a>
        <a href="/admin" class="active">Admin</a>
    </nav>
    <div class="container">
        <div id="login-view">
            <h1>系統管理登入</h1>
            <div class="notice">
                <p><strong>此頁面為系統管理員專用。</strong></p>
                <p>如果您是本系統的管理員，請在下方輸入您的主金鑰以存取管理功能。</p>
                <p><strong>如果您是一般使用者且需要存取金鑰，請聯繫您的服務提供商或代理商取得。</strong></p>
            </div>
            <input type="password" id="master-key-input" placeholder="請輸入主金鑰 (Master Key)">
            <button id="login-btn">登入</button>
            <p id="error-message" class="hidden"></p>
        </div>

        <div id="management-view" class="hidden">
            <h1>金鑰管理面板</h1>
            <button id="generate-btn">產生新金鑰</button>
            <button id="logout-btn">登出</button>
            <div id="new-key-display" class="hidden"></div>

            <h2>現存金鑰</h2>
            <ul id="key-list"></ul>
        </div>
    </div>

    <script>
        const loginView = document.getElementById('login-view');
        const managementView = document.getElementById('management-view');
        const masterKeyInput = document.getElementById('master-key-input');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const generateBtn = document.getElementById('generate-btn');
        const newKeyDisplay = document.getElementById('new-key-display');
        const keyList = document.getElementById('key-list');
        const errorMessage = document.getElementById('error-message');

        let masterKey = '';

        function showManagementView() {
            loginView.classList.add('hidden');
            managementView.classList.remove('hidden');
            loadKeys();
        }

        function showLoginView() {
            managementView.classList.add('hidden');
            loginView.classList.remove('hidden');
            masterKeyInput.value = '';
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            errorMessage.classList.add('hidden');
            const headers = { 'Authorization': `Bearer ${masterKey}` };
            const options = { method, headers };
            if (body) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: `HTTP error! Status: ${response.status}` }));
                    throw new Error(error.detail);
                }
                if (response.status === 204) return {};
                return await response.json();
            } catch (error) {
                errorMessage.textContent = `API Error: ${error.message}`;
                errorMessage.classList.remove('hidden');
                // If token is invalid, clear session storage and force re-login
                if (error.message.toLowerCase().includes('unauthorized') || error.message.toLowerCase().includes('invalid')) {
                    sessionStorage.removeItem('masterKey');
                    showLoginView();
                }
                return null;
            }
        }

        async function loadKeys() {
            const data = await apiCall('/api/admin/keys');
            if (data && data.user_keys) {
                keyList.innerHTML = '';
                data.user_keys.forEach(key => {
                    const li = document.createElement('li');
                    li.textContent = key;
                    const revokeBtn = document.createElement('button');
                    revokeBtn.textContent = '撤銷';
                    revokeBtn.className = 'revoke-btn';
                    revokeBtn.onclick = () => revokeKey(key);
                    li.appendChild(revokeBtn);
                    keyList.appendChild(li);
                });
            }
        }

        async function generateKey() {
            newKeyDisplay.classList.add('hidden');
            const data = await apiCall('/api/admin/generate-key', 'POST');
            if (data && data.new_key) {
                newKeyDisplay.textContent = `成功! 新金鑰: ${data.new_key}`;
                newKeyDisplay.classList.remove('hidden');
                await loadKeys();
            }
        }

        async function revokeKey(key) {
            if (!confirm(`確定要撤銷金鑰 ${key} 嗎？此操作無法復原。`)) return;
            const data = await apiCall('/api/admin/revoke-key', 'POST', { key_to_revoke: key });
            if (data) {
                await loadKeys();
            }
        }

        loginBtn.addEventListener('click', async () => {
            const enteredKey = masterKeyInput.value.trim();
            if (!enteredKey) {
                alert('請輸入主金鑰。');
                return;
            }
            masterKey = enteredKey;
            // Test the key by trying to fetch the key list
            const data = await apiCall('/api/admin/keys');
            if (data) {
                sessionStorage.setItem('masterKey', masterKey);
                showManagementView();
            }
        });

        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('masterKey');
            masterKey = '';
            showLoginView();
        });

        generateBtn.addEventListener('click', generateKey);

        // Initializer function
        function init() {
            const storedKey = sessionStorage.getItem('masterKey');
            if (storedKey) {
                masterKey = storedKey;
                showManagementView();
            }
        }

        // Run on page load
        init();
    </script>
</body>
</html>
