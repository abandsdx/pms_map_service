<!DOCTYPE html>
<html lang="{{ lang_code | default('en') }}">
<head>
    <meta charset="UTF-8">
    <title>{{ i18n.log_viewer_title | default('Log Viewer') }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1000px; margin: 1em auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #5a5a5a; border-bottom: 1px solid #eee; padding-bottom: 0.5em;}
        nav { background: #333; padding: 1em; text-align: center; display: flex; justify-content: center; align-items: center; }
        nav a { color: white; text-decoration: none; margin: 0 1em; font-size: 1.1em; }
        nav a.active { font-weight: bold; text-decoration: underline; }
        .nav-actions { display: flex; align-items: center; margin-left: auto; }
        .lang-switcher select { background-color: #555; color: white; border: 1px solid #666; padding: 5px; border-radius: 4px; margin-right: 15px; }
        #nav-logout-btn { background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        #nav-logout-btn:hover { background-color: #5a6268; }
        .status-bar { padding: 10px; margin-bottom: 1em; border-radius: 4px; text-align: center; }
        .status-bar span { font-weight: bold; }
        .status-connected { background-color: #d4edda; color: #155724; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; }
        .status-connecting { background-color: #e9f7ff; color: #004085; }
        .log { background: #2b2b2b; color: #f0f0f0; border: 1px solid #ddd; padding: 10px; height: 60vh; overflow-y: auto; font-family: monospace; }
        .log-entry { margin-bottom: 10px; white-space: pre-wrap; }
        .log-entry pre { margin: 0; }
    </style>
</head>
<body>
    <nav id="nav-bar"></nav>
    <div class="container">
        <h1>{{ i18n.log_viewer_title | default('Real-time Logs') }}</h1>
        <div id="status-bar" class="status-bar status-connecting">
            {{ i18n.log_ws_status | default('WebSocket') }}: <span id="ws-status">Connecting...</span> |
            {{ i18n.log_mqtt_status | default('MQTT Broker') }}: <span id="mqtt-status">Unknown</span>
        </div>
        <div class="log" id="log"></div>
    </div>

    <script>
        const i18n = {{ i18n | tojson }};
        const langCode = '{{ lang_code | default('en') }}';

        const log = document.getElementById('log');
        const wsStatus = document.getElementById('ws-status');
        const mqttStatus = document.getElementById('mqtt-status');
        const statusBar = document.getElementById('status-bar');
        const navBar = document.getElementById('nav-bar');

        function handleLogout() {
            sessionStorage.clear();
            window.location.href = `/?lang=${localStorage.getItem('lang') || langCode}`;
        }

        function renderNavbar(role, currentPage) {
            const savedLang = localStorage.getItem('lang') || langCode;
            const logUrl = `/log?lang=${savedLang}`;
            const settingsUrl = `/settings?lang=${savedLang}`;
            const adminUrl = `/admin?lang=${savedLang}`;

            const navLogViewer = i18n.nav_log_viewer || 'Log Viewer';
            const navMqttSettings = i18n.nav_mqtt_settings || 'MQTT Settings';
            const navAdmin = i18n.nav_admin || 'Admin';
            const navLogout = i18n.admin_logout_button || 'Logout';

            let navLinks = '';
            if (role === 'admin') {
                // Admin sees all links when not on the admin page
                navLinks += `<a href="${logUrl}" ${currentPage === 'log' ? 'class="active"' : ''}>${navLogViewer}</a>`;
                navLinks += `<a href="${settingsUrl}" ${currentPage === 'settings' ? 'class="active"' : ''}>${navMqttSettings}</a>`;
                navLinks += `<a href="${adminUrl}">${navAdmin}</a>`;
            } else {
                // User only sees log and settings
                navLinks += `<a href="${logUrl}" ${currentPage === 'log' ? 'class="active"' : ''}>${navLogViewer}</a>`;
                navLinks += `<a href="${settingsUrl}" ${currentPage === 'settings' ? 'class="active"' : ''}>${navMqttSettings}</a>`;
            }

            const navActions = `
                <div class="nav-actions">
                    <div class="lang-switcher">
                        <select id="lang-select">
                            <option value="en" ${savedLang === 'en' ? 'selected' : ''}>English</option>
                            <option value="zh_TW" ${savedLang === 'zh_TW' ? 'selected' : ''}>繁體中文</option>
                        </select>
                    </div>
                    <button id="nav-logout-btn">${navLogout}</button>
                </div>`;

            navBar.innerHTML = navLinks + navActions;

            document.getElementById('lang-select').addEventListener('change', (event) => {
                const newLang = event.target.value;
                localStorage.setItem('lang', newLang);
                window.location.href = `/${currentPage}?lang=${newLang}`;
            });
            document.getElementById('nav-logout-btn').addEventListener('click', handleLogout);
        }

        function connectWebSocket(token) {
            const wsUrl = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws?token=${token}`;
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log("WebSocket connection established.");
                wsStatus.textContent = "Connected";
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'system_status' && message.data.mqtt_status) {
                    mqttStatus.textContent = message.data.mqtt_status;
                    if (message.data.mqtt_status.toLowerCase().includes('connected')) {
                        statusBar.className = 'status-bar status-connected';
                    } else if (message.data.mqtt_status.toLowerCase().includes('error')) {
                        statusBar.className = 'status-bar status-disconnected';
                    } else {
                        statusBar.className = 'status-bar status-connecting';
                    }
                    return;
                }
                const entry = document.createElement("div");
                entry.classList.add("log-entry");
                let logTime = message._log_prefix || new Date().toLocaleString();
                entry.innerHTML = `${logTime} [${message.type.toUpperCase()}] <pre>${JSON.stringify(message.data, null, 2)}</pre>`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            };

            ws.onerror = (e) => {
                console.error("WebSocket error observed:", e);
                wsStatus.textContent = "Connection Error";
                statusBar.className = 'status-bar status-disconnected';
            };

            ws.onclose = (e) => {
                console.log(`WebSocket connection closed: Code=${e.code}, Reason=${e.reason}`);
                if (e.code === 4001) {
                    wsStatus.textContent = "Disconnected (Invalid API Key)";
                    sessionStorage.removeItem('userApiKey');
                } else {
                    wsStatus.textContent = "Disconnected";
                }
                mqttStatus.textContent = "N/A";
                statusBar.className = 'status-bar status-disconnected';
            };
        }

        function init() {
            const savedLang = localStorage.getItem('lang');
            if (savedLang && savedLang !== langCode) {
                window.location.href = `/log?lang=${savedLang}`;
                return;
            }

            const userApiKey = sessionStorage.getItem('userApiKey');
            const role = sessionStorage.getItem('apiRole');

            if (!userApiKey) {
                // An admin might be viewing this page, but they MUST have impersonated a user.
                // A user must have their own key.
                alert('Access denied. Please login first.');
                window.location.href = `/?lang=${savedLang || langCode}`;
                return;
            }

            renderNavbar(role, 'log');
            connectWebSocket(userApiKey);
        }

        init();
    </script>
</body>
</html>
